name: ✨ Check Quality

on: pull_request

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  code:
    name: ♻️ Static Code Analysis
    runs-on: ubuntu-24.04

    steps:
      - name: ᛘ Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ github.head_ref}}

      - name: 🔨 Setup pnpm
        uses: ./.github/actions/pnpm-setup

      - name: ✨ Quality check
        run: pnpm quality:check

  test-unit:
    name: 🧪 Unit Test
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: ᛘ Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ github.head_ref}}

      - name: 🔨 Setup pnpm
        uses: ./.github/actions/pnpm-setup

      - name: ✅ Vitest
        run: pnpm test:unit-coverage

      - name: 📝 Create coverage report
        uses: davelosert/vitest-coverage-report-action@8ab049ff5a2c6e78f78af446329379b318544a1a # v2.8.3
        with:
          json-summary-path: .vitest/coverage-summary.json
          json-final-path: .vitest/coverage-final.json

  test-storybook:
    name: 🧪 Storybook Test
    runs-on: ubuntu-24.04
    container:
      # Make sure to grab the latest version of the Playwright image
      # https://playwright.dev/docs/docker#pull-the-image
      image: mcr.microsoft.com/playwright:v1.52.0-noble
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: ᛘ Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ github.head_ref}}

      - name: 🔨 Setup git
        env:
          REPO_NAME: ${{ github.repository }}
        run: |
          git config --global --add safe.directory /__w/${{ env.REPO_NAME }}/${{ env.REPO_NAME }}

      - name: 🔨 Setup pnpm
        uses: ./.github/actions/pnpm-setup

      - name: 🧪 Storybook Test
        run: pnpm test:storybook
